<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test - Challenge Stake</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #0f1419;
      color: white;
    }
    .test-section {
      background: #1a1f26;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: #22272e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      font-size: 16px;
    }
    pre {
      background: #22272e;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
  </style>
</head>
<body>
  <h1>üß™ Test Challenge Stake</h1>
  
  <div class="test-section">
    <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp</h2>
    <button onclick="checkTelegram()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram</button>
    <pre id="telegram-result"></pre>
  </div>

  <div class="test-section">
    <h2>2. –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h2>
    <input type="text" id="test-telegram-id" placeholder="Telegram ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789)">
    <input type="text" id="test-username" placeholder="Username">
    <input type="text" id="test-firstname" placeholder="–ò–º—è">
    <input type="text" id="test-lastname" placeholder="–§–∞–º–∏–ª–∏—è">
    <button onclick="testRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    <pre id="register-result"></pre>
  </div>

  <div class="test-section">
    <h2>3. –¢–µ—Å—Ç –≤—Ö–æ–¥–∞</h2>
    <input type="text" id="login-telegram-id" placeholder="Telegram ID">
    <button onclick="testLogin()">–í–æ–π—Ç–∏</button>
    <pre id="login-result"></pre>
  </div>

  <div class="test-section">
    <h2>4. –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–≤</h2>
    <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <pre id="console-logs"></pre>
  </div>

  <script type="module">
    import { ConvexHttpClient } from "https://cdn.jsdelivr.net/npm/convex@1.31.2/+esm";

    const CONVEX_URL = "https://greedy-badger-196.convex.cloud";
    const client = new ConvexHttpClient(CONVEX_URL);

    window.client = client;

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    const originalLog = console.log;
    const originalError = console.error;
    const logs = [];

    function addLog(type, ...args) {
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      logs.push(`[${type}] ${message}`);
      document.getElementById('console-logs').textContent = logs.join('\n');
    }

    console.log = (...args) => {
      originalLog(...args);
      addLog('LOG', ...args);
    };

    console.error = (...args) => {
      originalError(...args);
      addLog('ERROR', ...args);
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
    window.checkTelegram = () => {
      const result = document.getElementById('telegram-result');
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        result.innerHTML = `<span class="success">‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω</span>\n\n` +
          `Platform: ${tg.platform}\n` +
          `Version: ${tg.version}\n` +
          `User: ${JSON.stringify(tg.initDataUnsafe?.user, null, 2)}`;
      } else {
        result.innerHTML = `<span class="error">‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>\n\n` +
          `–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram Mini App`;
      }
    };

    // –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    window.testRegister = async () => {
      const result = document.getElementById('register-result');
      const telegramId = document.getElementById('test-telegram-id').value;
      const username = document.getElementById('test-username').value;
      const firstName = document.getElementById('test-firstname').value;
      const lastName = document.getElementById('test-lastname').value;

      if (!telegramId || !username) {
        result.innerHTML = '<span class="error">‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ Telegram ID –∏ Username</span>';
        return;
      }

      try {
        result.innerHTML = '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
        console.log('Registering user:', { telegramId, username, firstName, lastName });
        
        const user = await client.mutation("users:registerTelegram", {
          telegramId,
          username,
          firstName: firstName || undefined,
          lastName: lastName || undefined,
        });

        result.innerHTML = `<span class="success">‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</span>\n\n` +
          JSON.stringify(user, null, 2);
        console.log('Registration successful:', user);
      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>\n\n` +
          JSON.stringify(error, null, 2);
        console.error('Registration failed:', error);
      }
    };

    // –¢–µ—Å—Ç –≤—Ö–æ–¥–∞
    window.testLogin = async () => {
      const result = document.getElementById('login-result');
      const telegramId = document.getElementById('login-telegram-id').value;

      if (!telegramId) {
        result.innerHTML = '<span class="error">‚ùå –í–≤–µ–¥–∏—Ç–µ Telegram ID</span>';
        return;
      }

      try {
        result.innerHTML = '‚è≥ –í—Ö–æ–¥...';
        console.log('Logging in user:', telegramId);
        
        const user = await client.query("users:loginTelegram", {
          telegramId,
        });

        result.innerHTML = `<span class="success">‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!</span>\n\n` +
          JSON.stringify(user, null, 2);
        console.log('Login successful:', user);
      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>\n\n` +
          JSON.stringify(error, null, 2);
        console.error('Login failed:', error);
      }
    };

    window.clearLogs = () => {
      logs.length = 0;
      document.getElementById('console-logs').textContent = '';
    };

    console.log('Test page loaded');
    console.log('Convex URL:', CONVEX_URL);
  </script>
</body>
</html>
