# Тестирование раздела "Лента"

## Что было исправлено

### Основная проблема
В файле `public/app.js` была дублирующая функция `showFeedReports`, которая перезаписывала правильную async версию и показывала только заглушку вместо загрузки отчётов из базы данных.

### Исправление
Удалена неправильная синхронная версия функции `showFeedReports` (строки ~1020-1035).

## Как проверить исправления

### 1. Проверка данных в базе
Откройте файл `check-data.html` в браузере:
```bash
open check-data.html
```

Этот файл автоматически проверит:
- ✅ Есть ли отчёты в таблице `progressUpdates`
- ✅ Есть ли активные челленджи в таблице `challenges`
- ✅ Работает ли API Convex

**Ожидаемый результат:**
- Если в БД есть отчёты, вы увидите их список
- Если отчётов нет, вы увидите сообщение "Отчётов не найдено"

### 2. Проверка логики переключения вкладок
Откройте файл `test-feed.html` в браузере:
```bash
open test-feed.html
```

Этот файл содержит симуляцию раздела "Лента" с тестовыми данными.

**Проверьте:**
- ✅ При загрузке страницы активна вкладка "Отчёты"
- ✅ Отображаются 2 тестовых отчёта
- ✅ При клике на "Все челленджи" вкладка переключается
- ✅ Отображаются 2 тестовых челленджа

### 3. Проверка в реальном приложении

#### Шаг 1: Запустите Convex
```bash
npm run convex:dev
```

#### Шаг 2: Запустите приложение
```bash
npm run dev
```

#### Шаг 3: Откройте приложение в браузере
```
http://localhost:5173
```

#### Шаг 4: Откройте консоль браузера (F12)
Вы должны увидеть логи:
```
=== App initialization started ===
Initializing Telegram...
...
=== switchScreen called: feed
Loading feed reports immediately...
=== showFeedReports called ===
Fetching reports...
Reports received: X [...]
Reports rendered successfully
```

#### Шаг 5: Проверьте раздел "Лента"
1. Нажмите на кнопку "Лента" в нижнем меню
2. Должна быть активна вкладка "Отчёты" (зелёная)
3. Если в БД есть отчёты, они должны отображаться
4. Если отчётов нет, должно быть сообщение "Пока нет отчётов"

#### Шаг 6: Переключитесь на "Все челленджи"
1. Нажмите на вкладку "Все челленджи"
2. Вкладка должна стать активной (зелёной)
3. Должны загрузиться активные челленджи
4. Если челленджей нет, должно быть сообщение "Пока нет челленджей"

## Создание тестовых данных

Если в базе нет отчётов, создайте их:

### 1. Создайте челлендж
1. Перейдите в раздел "Профиль"
2. Нажмите "Создать челлендж"
3. Заполните форму и создайте челлендж

### 2. Добавьте отчёт
1. Нажмите на кнопку "+" в нижнем меню
2. Выберите созданный челлендж
3. Напишите текст отчёта
4. Нажмите "Опубликовать отчёт"

### 3. Проверьте ленту
1. Перейдите в раздел "Лента"
2. Вы должны увидеть свой отчёт

## Отладка

### Проблема: Отчёты не загружаются
**Проверьте в консоли:**
```javascript
// Должно быть:
=== showFeedReports called ===
Fetching reports...
Reports received: 0 []

// Если видите ошибку:
=== Error loading reports ===
Error: [текст ошибки]
```

**Возможные причины:**
1. Convex не запущен (`npm run convex:dev`)
2. Неправильный URL в `CONVEX_URL`
3. Нет отчётов в БД
4. Ошибка в функции `getAllReports`

### Проблема: Вкладки не переключаются
**Проверьте в консоли:**
```javascript
// Должно быть:
=== showFeedReports called ===
Switched to "Отчёты" tab

// или
=== showChallenges called: all
Switched to "Все челленджи" tab
```

**Возможные причины:**
1. Не найдены элементы `.tab-btn`
2. JavaScript не загрузился
3. Ошибка в коде

### Проблема: Все челленджи подсвечены как активные
Это нормально! Функция `getAll` в Convex загружает только активные челленджи:
```typescript
.withIndex("by_status", (q) => q.eq("status", "active"))
```

Если вы хотите видеть все челленджи (включая завершённые и проваленные), измените функцию `getAll` в `convex/challenges.ts`.

## Структура кода

### Поток данных для отчётов
```
Пользователь нажимает "Лента"
  ↓
switchScreen('feed')
  ↓
showFeedReports()
  ↓
client.query("challenges:getAllReports", {})
  ↓
Convex: getAllReports()
  ↓
Получение данных из progressUpdates
  ↓
Обогащение данными из users и challenges
  ↓
Возврат данных в приложение
  ↓
Рендеринг карточек отчётов
```

### Поток данных для челленджей
```
Пользователь нажимает "Все челленджи"
  ↓
showChallenges('all')
  ↓
loadChallenges('all')
  ↓
client.query("challenges:getAll", {})
  ↓
Convex: getAll()
  ↓
Получение активных челленджей
  ↓
Обогащение данными из users
  ↓
Возврат данных в приложение
  ↓
displayChallenges()
  ↓
Рендеринг карточек челленджей
```

## Дополнительные файлы

- `FEED_FIX.md` - подробное описание исправлений
- `test-feed.html` - тестовая страница для проверки логики
- `check-data.html` - проверка данных в Convex
